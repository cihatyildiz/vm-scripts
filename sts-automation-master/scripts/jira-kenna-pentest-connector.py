# ----------------------------------------------------------------------
# Updated: 07/15/2021
# Author: Cihat Yildiz
#
# Description: This script get penetration test tickets from Jira and 
#   creates vulnerailities in Kenna. 
#       Steps: 
#         1. Get all jira ticket information
#         2. Check all the required fields are set
#         3. Create vulnerability in Kenna 
# ----------------------------------------------------------------------    

import sys, os, requests, json, time
from requests.auth import HTTPBasicAuth
from datetime import datetime

import requests.packages.urllib3
requests.packages.urllib3.disable_warnings()

from lib.jira import *
from lib.kenna import *

jira_username = os.environ['JIRA_USERNAME'].replace('"', "")
jira_password = os.environ['JIRA_PASSWORD'].replace('"', "")
kenna_api_token = os.environ['KENNA_TOKEN'].replace('"', "")

# => Run
if __name__ == "__main__":
    jql = "project = CRVM AND component = \"Pentest Findings\" AND status != Done  AND status !=Closed"
    #jira_issues = getJiraPentestIssuesByJQL(HTTPBasicAuth(jira_username, jira_password), jql)
    result = getJiraIssuesByJql(HTTPBasicAuth(jira_username, jira_password), jql)
    for x in result:
        print(x)
    print(len(result))

